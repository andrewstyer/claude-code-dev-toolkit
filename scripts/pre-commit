#!/bin/bash
# Git pre-commit hook - Documentation validation
# Validates documentation files before allowing commit

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any documentation files are staged
DOCS_CHANGED=false
if echo "$STAGED_FILES" | grep -q "HANDOFF.md\|BLOCKERS.md\|RECOVERY.md\|END-SESSION.md\|CONTINUE-SESSION.md"; then
  DOCS_CHANGED=true
fi

# If no documentation files changed, skip validation
if [ "$DOCS_CHANGED" = false ]; then
  exit 0
fi

echo -e "${YELLOW}üìã Documentation files changed - running validation...${NC}"
echo ""

# Change to healthnarrative directory if we're in a subdirectory
if [ -f "scripts/validate-docs.sh" ]; then
  # Already in healthnarrative directory
  VALIDATION_SCRIPT="./scripts/validate-docs.sh"
elif [ -f "../scripts/validate-docs.sh" ]; then
  # In a subdirectory
  VALIDATION_SCRIPT="../scripts/validate-docs.sh"
elif [ -f "healthnarrative/scripts/validate-docs.sh" ]; then
  # In parent directory
  cd healthnarrative
  VALIDATION_SCRIPT="./scripts/validate-docs.sh"
else
  echo -e "${YELLOW}‚ö†Ô∏è  Warning: validate-docs.sh not found, skipping validation${NC}"
  exit 0
fi

# Run validation
if $VALIDATION_SCRIPT; then
  echo ""
  echo -e "${GREEN}‚úÖ Documentation validation passed - commit allowed${NC}"
  exit 0
else
  echo ""
  echo -e "${RED}‚ùå Documentation validation failed - commit blocked${NC}"
  echo ""
  echo -e "${YELLOW}To fix:${NC}"
  echo "  1. Review the validation errors above"
  echo "  2. Fix the documentation issues"
  echo "  3. Stage your changes: git add [files]"
  echo "  4. Try committing again"
  echo ""
  echo -e "${YELLOW}To bypass (NOT recommended):${NC}"
  echo "  git commit --no-verify"
  echo ""
  exit 1
fi
