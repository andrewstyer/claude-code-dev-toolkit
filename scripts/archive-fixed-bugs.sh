#!/usr/bin/env bash
# Archive resolved bugs from bugs.yaml to keep the active file manageable
# Moves bugs with status="resolved" to archive/bugs/YYYY-MM.yaml

set -euo pipefail

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Files and directories
BUGS_FILE="bugs.yaml"
ARCHIVE_DIR="archive/bugs"
TIMESTAMP=$(date +%Y-%m)
ARCHIVE_FILE="$ARCHIVE_DIR/$TIMESTAMP.yaml"

# Check for required tools
if ! command -v yq &> /dev/null; then
  echo -e "${RED}‚ùå yq not found${NC}"
  echo "   Install with: pip install yq"
  exit 1
fi

echo -e "${BLUE}üì¶ Archiving resolved bugs from bugs.yaml...${NC}"
echo ""

# Check if bugs.yaml exists
if [ ! -f "$BUGS_FILE" ]; then
  echo -e "${RED}‚ùå bugs.yaml not found${NC}"
  echo "   Make sure you're in the project root directory"
  exit 1
fi

# Count resolved bugs
RESOLVED_COUNT=$(yq '.bugs[] | select(.status == "resolved") | .id' "$BUGS_FILE" 2>/dev/null | wc -l | tr -d ' ')
TOTAL_COUNT=$(yq '.bugs | length' "$BUGS_FILE" 2>/dev/null)

echo "Current bugs.yaml status:"
echo "  Total bugs: $TOTAL_COUNT"
echo "  Resolved bugs: $RESOLVED_COUNT"
echo "  Active bugs: $((TOTAL_COUNT - RESOLVED_COUNT))"
echo ""

# Check if there are bugs to archive
if [ "$RESOLVED_COUNT" -eq 0 ]; then
  echo -e "${GREEN}‚úÖ No resolved bugs to archive${NC}"
  echo "   All bugs are still active or in-progress"
  exit 0
fi

# Show which bugs will be archived
echo -e "${BLUE}Bugs to be archived:${NC}"
yq -r '.bugs[] | select(.status == "resolved") | "  ‚Ä¢ " + .id + ": " + .title + " (resolved at: " + (.resolved_at // "unknown") + ")"' "$BUGS_FILE"
echo ""

# Confirm archival
read -p "Archive these $RESOLVED_COUNT resolved bugs? (y/N) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "Archival cancelled"
  exit 0
fi

# Create archive directory if it doesn't exist
mkdir -p "$ARCHIVE_DIR"

# Initialize or read existing archive file
if [ -f "$ARCHIVE_FILE" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Archive file for $TIMESTAMP already exists${NC}"
  echo "   Resolved bugs will be appended to: $ARCHIVE_FILE"
  echo ""
else
  # Create new archive file with header
  cat > "$ARCHIVE_FILE" <<EOF
# Archived Bugs - $TIMESTAMP
# Bugs resolved and archived from bugs.yaml
# This file is automatically generated by scripts/archive-fixed-bugs.sh

archivedAt: "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
archivedCount: 0

bugs: []
EOF
fi

# Extract resolved bugs and append to archive
echo -e "${BLUE}Extracting resolved bugs...${NC}"

# Create a new archive file with all bugs
TEMP_NEW_ARCHIVE=$(mktemp)

# Start building the new archive file
{
  echo "# Archived Bugs - $TIMESTAMP"
  echo "# Bugs resolved and archived from bugs.yaml"
  echo "# This file is automatically generated by scripts/archive-fixed-bugs.sh"
  echo ""
  echo "archivedAt: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\""
  echo "archivedCount: 0  # Will be updated"
  echo ""
  echo "bugs:"
} > "$TEMP_NEW_ARCHIVE"

# Add existing archived bugs (if any)
if [ -f "$ARCHIVE_FILE" ] && [ -s "$ARCHIVE_FILE" ]; then
  yq -r '.bugs[]?' "$ARCHIVE_FILE" 2>/dev/null | while IFS= read -r line; do
    if [ -n "$line" ]; then
      echo "  $line"
    fi
  done >> "$TEMP_NEW_ARCHIVE" || true
fi

# Add newly resolved bugs with archived_at timestamp
ARCHIVED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
while IFS= read -r bug_id; do
  if [ -n "$bug_id" ]; then
    echo "  Archiving $bug_id..."
    # Extract bug and add to array format
    yq -y ".bugs[] | select(.id == \"$bug_id\") | . + {archived_at: \"$ARCHIVED_AT\"}" "$BUGS_FILE" | sed 's/^/  /' >> "$TEMP_NEW_ARCHIVE"
  fi
done < <(yq -r '.bugs[] | select(.status == "resolved") | .id' "$BUGS_FILE")

# Move temp file to archive
mv "$TEMP_NEW_ARCHIVE" "$ARCHIVE_FILE"

# Update the archivedCount
ARCHIVED_TOTAL=$(yq '.bugs | length' "$ARCHIVE_FILE")
# Use sed to update the count (simpler than yq -i which might have issues)
sed -i "s/archivedCount: .*/archivedCount: $ARCHIVED_TOTAL/" "$ARCHIVE_FILE"

# Remove resolved bugs from bugs.yaml (keep only non-resolved)
echo -e "${BLUE}Updating bugs.yaml...${NC}"

# Backup original file
cp "$BUGS_FILE" "${BUGS_FILE}.backup"

# Keep nextId and remove resolved bugs
NEXT_ID=$(yq '.nextId' "$BUGS_FILE")
yq -y "
  .bugs = [.bugs[] | select(.status != \"resolved\")] |
  .nextId = $NEXT_ID
" "$BUGS_FILE" > "${BUGS_FILE}.tmp"

mv "${BUGS_FILE}.tmp" "$BUGS_FILE"

# Verify the operation
NEW_TOTAL=$(yq '.bugs | length' "$BUGS_FILE" 2>/dev/null)
EXPECTED_TOTAL=$((TOTAL_COUNT - RESOLVED_COUNT))

if [ "$NEW_TOTAL" -eq "$EXPECTED_TOTAL" ]; then
  echo -e "${GREEN}‚úÖ Successfully archived $RESOLVED_COUNT bugs${NC}"
  rm "${BUGS_FILE}.backup"
else
  echo -e "${RED}‚ùå Error during archival${NC}"
  echo "   Expected $EXPECTED_TOTAL bugs, but found $NEW_TOTAL"
  echo "   Restoring backup..."
  mv "${BUGS_FILE}.backup" "$BUGS_FILE"
  exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ Archival complete${NC}"
echo "   Archived: $RESOLVED_COUNT bugs ‚Üí $ARCHIVE_FILE"
echo "   Remaining in bugs.yaml: $NEW_TOTAL active bugs"
echo ""
echo -e "${BLUE}Summary:${NC}"
echo "   Archive location: $ARCHIVE_FILE"
echo "   Archive contains: $ARCHIVED_TOTAL bugs total"
echo "   bugs.yaml now has: $NEW_TOTAL bugs"
echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "   1. Review archived bugs: cat $ARCHIVE_FILE"
echo "   2. Verify bugs.yaml: cat $BUGS_FILE"
echo "   3. Update index if needed: cp bugs.yaml docs/bugs/index.yaml"
echo "   4. Commit changes: git add bugs.yaml $ARCHIVE_FILE && git commit -m 'chore: archive $RESOLVED_COUNT resolved bugs'"
echo ""
echo -e "${BLUE}Tip:${NC} Run this script monthly or when bugs.yaml exceeds 50 bugs"
